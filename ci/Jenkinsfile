pipeline {
    agent any
    
    environment {
        NODE_VERSION = '22'
        DEPLOY_SERVER = 'bridge'  // Bridge ì„œë²„ (VMware Rocky9)
        DEPLOY_USER = 'root'  // Bridge ì„œë²„ ì‚¬ìš©ì
        DEPLOY_PATH = '/opt/blockchain-game'
        PM2_APP_NAME = 'blockchain-bridge'
        DB_HOST = 'db'  // MariaDB ì„œë²„
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ğŸ“¦ ì½”ë“œ ì²´í¬ì•„ì›ƒ...'
                checkout scm
            }
        }
        
        stage('Install Dependencies') {
            steps {
                echo 'ğŸ“¥ ì˜ì¡´ì„± ì„¤ì¹˜...'
                sh '''
                    npm ci
                    
                '''
            }
        }
        
        stage('Lint & Test') {
            parallel {
                stage('Lint') {
                    steps {
                        echo 'ğŸ” ì½”ë“œ ë¦°íŠ¸ ê²€ì‚¬...'
                        sh '''
                            npm run lint || echo "Lint not configured"
                        '''
                    }
                }
                
                stage('Test') {
                    steps {
                        echo 'ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰...'
                        sh '''
                            npm test || echo "Tests not configured"
                        '''
                    }
                }
            }
        }
        
        stage('Build') {
            steps {
                echo 'ğŸ”¨ ë¹Œë“œ ì¤€ë¹„...'
                sh '''
                    # ë°°í¬ìš© íŒŒì¼ë§Œ ë³µì‚¬ (server + marketplaceë§Œ)
                    mkdir -p dist
                    cp -r server dist/
                    cp -r marketplace dist/
                    cp package*.json dist/
                    cp .env.example dist/
                '''
            }
        }
        

        stage('Debug ENV_FILE') {
            steps {
                sshagent(['deploy-ssh-key']) { // êµ³ì´ ì•ˆ ì¨ë„ ë˜ì§€ë§Œ ì¼ë‹¨ ë™ì¼í™˜ê²½
                    withCredentials([file(credentialsId: 'bridge-env-file', variable: 'ENV_FILE')]) {
                        sh '''
                            echo "ENV_FILE ê²½ë¡œ: $ENV_FILE"
                            ls -l "$ENV_FILE" || echo "ENV_FILE íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"

                            # ì›ê²©ìœ¼ë¡œ ê·¸ëƒ¥ catë§Œ ë³´ë‚´ë³´ê¸° (scp ëŒ€ì‹ )
                            ssh ${DEPLOY_USER}@${DEPLOY_SERVER} "mkdir -p ${DEPLOY_PATH}"
                            scp "$ENV_FILE" ${DEPLOY_USER}@${DEPLOY_SERVER}:${DEPLOY_PATH}/.env.debug
                        '''
                    }
                }
            }
        }

        stage('Deploy to Server') {
            steps {
                echo 'ğŸš€ ì„œë²„ ë°°í¬ ì¤‘...'
                sshagent(['deploy-ssh-key']) {
                    // 1) .env ë¨¼ì € ì „ì†¡
                    withCredentials([file(credentialsId: 'bridge-env-file', variable: 'ENV_FILE')]) {
                        sh '''
                            echo "ğŸ“ .env íŒŒì¼ ì „ì†¡..."
                            ssh ${DEPLOY_USER}@${DEPLOY_SERVER} "mkdir -p ${DEPLOY_PATH}"
                            scp "$ENV_FILE" ${DEPLOY_USER}@${DEPLOY_SERVER}:${DEPLOY_PATH}/.env
                        '''
                    }
                    
                    // 2) ì•± íŒŒì¼ rsync
                    sh '''
                        echo "ğŸ“¦ dist íŒŒì¼ rsync..."
                        rsync -avz --delete \
                            --exclude 'node_modules' \
                            --exclude '.git' \
                            --exclude 'test' \
                            --exclude 'contracts' \
                            --exclude 'scripts' \
                            --exclude '.env' \
                            dist/ ${DEPLOY_USER}@${DEPLOY_SERVER}:${DEPLOY_PATH}/
                    '''
                    
                    // 3) ì›ê²© ì„œë²„ì—ì„œ npm/pm2 ì‹¤í–‰
                    sh '''
                        echo "ğŸ›  ì›ê²© ì„œë²„ ì„¤ì •..."
                        ssh ${DEPLOY_USER}@${DEPLOY_SERVER} << 'ENDSSH'
                            cd ${DEPLOY_PATH}
                            
                            echo "í˜„ì¬ ë””ë ‰í† ë¦¬:"
                            pwd
                            
                            echo "íŒŒì¼ ëª©ë¡:"
                            ls -al
                            
                            if [ ! -f .env ]; then
                                echo "âŒ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
                                exit 1
                            fi
                            
                            npm ci --production
                            pm2 restart ${PM2_APP_NAME} || pm2 start server/index.js --name ${PM2_APP_NAME}
                            pm2 save
                            
                            echo "âœ… ë°°í¬ ì™„ë£Œ!"
ENDSSH
                    '''
                }
            }
        }
        
        stage('Health Check') {
            steps {
                echo 'ğŸ¥ í—¬ìŠ¤ ì²´í¬...'
                sh '''
                    sleep 5
                    curl -f http://${DEPLOY_SERVER}:3000/api/health || exit 1
                '''
            }
        }
    }
    
    post {
        success {
            echo 'âœ… ë°°í¬ ì„±ê³µ!'
            // Slack ì•Œë¦¼ ë“± ì¶”ê°€ ê°€ëŠ¥
        }
        failure {
            echo 'âŒ ë°°í¬ ì‹¤íŒ¨!'
            // ë¡¤ë°± ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
        }
        always {
            cleanWs()
        }
    }
}
