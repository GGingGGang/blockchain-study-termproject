pipeline {
    agent any
    
    environment {
        NODE_VERSION = '18'
        DEPLOY_SERVER = 'bridge'  // Bridge ì„œë²„ (VMware Rocky9)
        DEPLOY_USER = 'root'  // Bridge ì„œë²„ ì‚¬ìš©ì
        DEPLOY_PATH = '/opt/blockchain-game'
        PM2_APP_NAME = 'blockchain-bridge'
        DB_HOST = 'db'  // MariaDB ì„œë²„
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ğŸ“¦ ì½”ë“œ ì²´í¬ì•„ì›ƒ...'
                checkout scm
            }
        }
        
        stage('Install Dependencies') {
            steps {
                echo 'ğŸ“¥ ì˜ì¡´ì„± ì„¤ì¹˜...'
                sh '''
                    npm ci
                '''
            }
        }
        
        stage('Lint & Test') {
            parallel {
                stage('Lint') {
                    steps {
                        echo 'ğŸ” ì½”ë“œ ë¦°íŠ¸ ê²€ì‚¬...'
                        sh '''
                            npm run lint || echo "Lint not configured"
                        '''
                    }
                }
                
                stage('Test') {
                    steps {
                        echo 'ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰...'
                        sh '''
                            npm test || echo "Tests not configured"
                        '''
                    }
                }
            }
        }
        
        stage('Build') {
            steps {
                echo 'ğŸ”¨ ë¹Œë“œ ì¤€ë¹„...'
                sh '''
                    # ë°°í¬ìš© íŒŒì¼ë§Œ ë³µì‚¬ (server + marketplaceë§Œ)
                    mkdir -p dist
                    cp -r server dist/
                    cp -r marketplace dist/
                    cp package*.json dist/
                    cp .env.example dist/
                '''
            }
        }
        
        stage('Deploy to Server') {
            steps {
                echo 'ğŸš€ ì„œë²„ ë°°í¬ ì¤‘...'
                sshagent(['deploy-ssh-key']) {
                    sh '''
                        # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
                        ssh ${DEPLOY_USER}@${DEPLOY_SERVER} "mkdir -p ${DEPLOY_PATH}"
                        
                        # íŒŒì¼ ì „ì†¡
                        rsync -avz --delete \
                            --exclude 'node_modules' \
                            --exclude '.git' \
                            --exclude 'test' \
                            --exclude 'contracts' \
                            --exclude 'scripts' \
                            dist/ ${DEPLOY_USER}@${DEPLOY_SERVER}:${DEPLOY_PATH}/
                        
                        # ì„œë²„ì—ì„œ ì˜ì¡´ì„± ì„¤ì¹˜ ë° ì¬ì‹œì‘
                        ssh ${DEPLOY_USER}@${DEPLOY_SERVER} << 'ENDSSH'
                            cd ${DEPLOY_PATH}
                            
                            # .env íŒŒì¼ í™•ì¸
                            if [ ! -f .env ]; then
                                echo "âš ï¸  .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. .env.exampleì„ ë³µì‚¬í•˜ì„¸ìš”."
                                exit 1
                            fi
                            
                            # ì˜ì¡´ì„± ì„¤ì¹˜
                            npm ci --production
                            
                            # PM2ë¡œ ì¬ì‹œì‘
                            pm2 restart ${PM2_APP_NAME} || pm2 start server/index.js --name ${PM2_APP_NAME}
                            pm2 save
                            
                            echo "âœ… ë°°í¬ ì™„ë£Œ!"
ENDSSH
                    '''
                }
            }
        }
        
        stage('Health Check') {
            steps {
                echo 'ğŸ¥ í—¬ìŠ¤ ì²´í¬...'
                sh '''
                    sleep 5
                    curl -f http://${DEPLOY_SERVER}:3000/api/health || exit 1
                '''
            }
        }
    }
    
    post {
        success {
            echo 'âœ… ë°°í¬ ì„±ê³µ!'
            // Slack ì•Œë¦¼ ë“± ì¶”ê°€ ê°€ëŠ¥
        }
        failure {
            echo 'âŒ ë°°í¬ ì‹¤íŒ¨!'
            // ë¡¤ë°± ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
        }
        always {
            cleanWs()
        }
    }
}
